name: Build Combined Hagezi List Minus Majestic Million

on:
  schedule:
    - cron: "29 08 * * *"
  workflow_dispatch:

jobs:
  filter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download Hagezi lists
        run: |
          curl -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt"  -o tif.txt
          curl -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/nrd7.txt" -o nrd7.txt
          curl -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/dga14.txt" -o dga30.txt

      - name: Download Majestic Million
        run: |
          curl -L "https://tranco-list.eu/top-1m-incl-subdomains.csv.zip" -o tranco.zip
          unzip tranco.zip -d .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Run filter
        run: |
          python3 filter.py tif.txt nrd7.txt dga30.txt top-1m.csv filtered.txt

      - name: Commit results
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          mv filtered.txt combined-hagezi-minus-tranco.txt
          git add combined-hagezi-minus-tranco.txt

          git commit -m "Update combined filtered Hagezi list" || echo "No changes"
          git push
